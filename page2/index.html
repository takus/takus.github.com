
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>TAKUMI SAKAMOTO&#8217;S BLOG</title>
  <meta name="author" content="Takumi Sakamoto">

  
  <meta name="description" content="前半の部分をまとめようと思ったら、大切なことは全て @j3tm0t0 さんの gist に書いてあったので、SSH でログインできなくなった時はまず上記の gist に書いてあることを確認するといいと思います。 で、今回の話は、snapshot を取得して 新たに volume を作成して、 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.takus.me/page2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="TAKUMI SAKAMOTO'S BLOG" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2841066-12']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">TAKUMI SAKAMOTO&#8217;S BLOG</a></h1>
  
    <h2>A weblog about Web Operations, Programming, Football, Travel and Other My Interests.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.takus.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://about.me/takus">AboutMe</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/03/04/ec2-ssh/">EC2 に SSH できない時の対処法、あるいは Marketplace の AMI を気軽に選ぶべきでない理由</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/03/04/ec2-ssh/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/03/04/ec2-ssh/"></a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-04T00:00:00-08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前半の部分をまとめようと思ったら、大切なことは全て<a href="https://gist.github.com/j3tm0t0/5560892"> @j3tm0t0 さんの gist </a>に書いてあったので、SSH でログインできなくなった時はまず上記の gist に書いてあることを確認するといいと思います。</p>

<p>で、今回の話は、snapshot を取得して 新たに volume を作成して、他のインスタンスにアタッチ＆マウントしてエラーが出ていないかを確認しようとした時に下記のエラーでマウントできなかった件に関するお話です。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>'vol-xxxxxxx' with Marketplace codes may not be attached as as secondary device.</span></code></pre></td></tr></table></div></figure>


<p>ググったら <a href="http://www.quora.com/Amazon-EC2/Is-it-possible-to-rescue-an-EBS-volume-which-has-marketplace-codes">&ldquo;Is it possible to rescue an EBS volume which has marketplace codes?&rdquo;</a> や <a href="http://techblog.willshouse.com/2013/08/21/marketplace-codes-may-not-be-attached-as-a-secondary-device/">&ldquo;Marketplace codes may not be attached as a secondary device&rdquo;</a> といった記事を見つけて、まとめると、</p>

<ul>
<li>Marketplace で提供される AMI はルートボリューム以外にマウントできない</li>
<li>AWS のサポートに連絡するとマウントできない制限を解除してくれる</li>
</ul>


<p>とのことで、AWS のサポートに調査対象ボリュームのスナップショットを共有すると、マウントできない制限を解除してくれるようです。</p>

<p><a href="https://aws.amazon.com/marketplace/seller-profile/ref=dtl_pcp_sold_by?ie=UTF8&amp;id=16cb8b03-256e-4dde-8f34-1b0f377efe89">CentOS は公式の AMI が Marketplace で提供されてる</a>のでついつい選んでしまいがちですが、問題が起きた時のトラブルシューティングに一手間かかってしまうので、気軽な気持ちで選んでしまうと面倒なことになるよという話でした。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/03/01/octopress-hatena-bookmark/">Octopress で はてなブックマーク数 を表示する</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/03/01/octopress-hatena-bookmark/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/03/01/octopress-hatena-bookmark/"></a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-01T18:06:00-08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>6:06 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/takus/takus.github.com/commit/0cf6d223e4f2512c63652b8bc0147956b9d77722">https://github.com/takus/takus.github.com/commit/0cf6d223e4f2512c63652b8bc0147956b9d77722</a></p>

<p>こちらからは以上です。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/02/25/drone-on-centos/">Docker/Drone を CentOS 6.5 で動かして Github Enterprise のリポジトリをテストする</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/02/25/drone-on-centos/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/02/25/drone-on-centos/"></a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-02-25T20:03:00-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:03 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://farm6.staticflickr.com/5530/12768732363_934e22c97b_z.jpg" width="640" height="374" title="'Drone by Takumi Sakamoto (takus) on flickr.com'" ></p>

<p>&ldquo;Docker 使うなら Ubuntu だろ jk&rdquo; とか言われそうですが CentOS 6.5 で使いたかったので試してみました。<a href="https://www.docker.io/gettingstarted/">Docker の公式サイトには &ldquo;Our recommended installation path is for Ubuntu linux, because we develop Docker on Ubuntu and our installation package will do most of the work for you.&rdquo; と書いてあったり</a>、<a href="https://github.com/drone/drone">Drone は Ubuntu 用のパッケージしかなかったり</a>するので、深淵な理由がなければ Ubuntu 使うのがいいんじゃないかと思います。</p>

<h2>Docker のインストール</h2>

<p>CentOS 6.5 なら簡単にインストールできるので特にハマりどころはありませんでした。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rpm -Uvh http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm
</span><span class='line'>yum -y install docker-io
</span><span class='line'>chkconfig docker on
</span><span class='line'>service docker start
</span><span class='line'>
</span><span class='line'>docker run centos /bin/echo "Hello World"
</span><span class='line'>Hello World</span></code></pre></td></tr></table></div></figure>


<h2>Drone のビルド</h2>

<p>Makefile がリポジトリに入ってるので、Makefile でビルドしてあげます。<code>make deps</code> でこける場合は適宜、依存を解決してあげれば OK です。
golang 素人すぎて適当にやってしまいましたが、こうすべきみたいのがあれば優しく教えていただけると助かります。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum -y install golang
</span><span class='line'>echo 'export GOPATH=$HOME/go' &gt;&gt; ~/.bash_profile
</span><span class='line'>echo 'export PATH=$PATH:$GOPATH/bin' &gt;&gt; ~/.bash_profile
</span><span class='line'>source ~/.bash_profile
</span><span class='line'>
</span><span class='line'>yum -y install git hg bzr
</span><span class='line'>yum -y groupinstall "Development Tools"
</span><span class='line'>
</span><span class='line'>git clone https://github.com/drone/drone.git && cd drone
</span><span class='line'>make deps
</span><span class='line'>make && make test && make install
</span><span class='line'>droned</span></code></pre></td></tr></table></div></figure>


<h2>Drone で Github Enterprise のリポジトリをテストする</h2>

<p>後は <a href="http://yosssi.hatenablog.com/entry/2014/02/08/161500">Droneのオープンソース版を試してみました。</a> に従ってセットアップしていけばいいのですが、Github Enterprise のリポジトリを CI する場合はちょっとだけ対応が必要でした。</p>

<h3>1. Github API の URL 変更</h3>

<p><a href="http://DRONE_HOST/account/admin/settings">http://DRONE_HOST/account/admin/settings</a> の &ldquo;GitHub Settings&rdquo; で API の URL の変更します。
Github Enterprise の場合は GITHUB_DOMAIN / <a href="https://GITHUB_DOMAIN/api/v3">https://GITHUB_DOMAIN/api/v3</a> のように修正すればよさそうです。</p>

<h3>2. リポジトリの clone 方法の変更</h3>

<p><a href="https://github.com/drone/drone/issues/91">GitHub Enterprise &amp; Private Mode #91</a> にあるように、GitHub Enterprise を private mode で運用してる場合、<code>git://</code> プロトコルが使えないので、リポジトリの clone に失敗してしまっていました。Issue にあがってるくらいなのでそのうち解決されるかと思いますが、ワークアラウンドとして下記のようにソースを修正してビルドし直して使ってます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- a/pkg/model/repo.go</span>
</span><span class='line'><span class="gi">+++ b/pkg/model/repo.go</span>
</span><span class='line'><span class="gu">@@ -24,7 +24,7 @@ const (</span>
</span><span class='line'> )
</span><span class='line'>
</span><span class='line'> const (
</span><span class='line'><span class="gd">-       githubRepoPattern           = &quot;git://%s/%s/%s.git&quot;</span>
</span><span class='line'><span class="gi">+       githubRepoPattern           = &quot;git@%s:%s/%s.git&quot;</span>
</span><span class='line'>        githubRepoPatternPrivate    = &quot;git@%s:%s/%s.git&quot;
</span><span class='line'>        bitbucketRepoPattern        = &quot;https://bitbucket.org/%s/%s.git&quot;
</span><span class='line'>        bitbucketRepoPatternPrivate = &quot;git@bitbucket.org:%s/%s.git&quot;
</span></code></pre></td></tr></table></div></figure>


<h3>3. Github リポジトリにデプロイキーを登録</h3>

<p>これで万事解決と思いきや、今度は <code>git@</code> で clone してるにも関わらず、git clone に失敗する現象に遭遇しました。Drone のログをみてるとコンテナの初期化する際にリポジトリ毎の秘密鍵をおいているようで、Settings の Key Pairs にある公開鍵を Github リポジトリのデプロイキーに登録してあげたところ、無事に Clone できるようになりました。</p>

<p><img src="http://farm6.staticflickr.com/5475/12768591305_b2c6f232ee_z.jpg" width="640" height="310" title="'Drone by Takumi Sakamoto (takus) on flickr.com'" ></p>

<h2>まとめ</h2>

<p>ということで、無事に Drone 使えるようになったので、あとは各バージョンの perlbrew とか rbenv とか nodebrew を持ったイメージを作っておいて、それ毎にバージョン跨ぐテストしていくような感じにしていけばよさそうな雰囲気です。ざっと設定画面とコードを眺めたところ、Jenkins の Master/Slave みたいな仕組みがないので、数が増えていったらある程度 Drone を分けるしかなさそうですが、とりあえずはチーム毎とかそういう単位で Drone を用意してあげればいいのかなと思ってます。 Enjoy your test with Drone :D</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/02/25/money/">自分が撮影した写真をドイツの出版社に買ってもらった話</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/02/25/money/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/02/25/money/"></a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-02-25T02:04:00-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:04 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ある日、ドイツの出版社から Flickr で共有した御柱の写真を買いたいというオファーがあり、色々調べながら無事に取引できたので、取引の流れをまとめておきます。</p>

<h2>Flickr でのオファー</h2>

<blockquote><p>&hellip;. Through my research in Flickr I came across your profile and found an image we would like to use for our publication. &hellip;.</p></blockquote>

<p>Flickr メールにきたオファーはこんな感じの内容でした。雑誌名なども書いてあったのでググったら、どうやらちゃんとした会社のようだったので承諾。(ウソ書かれてても判断できないですが)</p>

<blockquote><p>&hellip;.. And you don´t have to give it for free. I can offer you 180Euro. How do you think?</p></blockquote>

<p>で、話を進めていくと、驚くことに 180 Euro でどう？って言われ、&#8221;銀行にお金振り込むから、RAW と一緒に請求書送ってね&#8221; とか言われたので、請求書をどうすればいいのかとか、ユーロってどう受け取るんだろうとか色々調べてみました。</p>

<h2>請求書の作成</h2>

<p>請求書は <a href="https://drive.google.com/templates#">Google Drive の請求書テンプレ</a> から適当に invoice を探して必要事項を記入し、PDF で出力するだけで OK でした。今回はシンプルな<a href="https://drive.google.com/previewtemplate?id=1twPZKGOMGQoisxCR2GIK2C1kCKxRazX-D10h5ucavUs&amp;mode=public">コチラ</a>を使わせていただきました。</p>

<h2>代金の受け取り</h2>

<p>ユーロで受け取るなら外貨建ての口座開かないといけないのかと思って萎えてたんですが、三菱東京 UFJ 銀行であれば円建てで受け取れます。具体的には下記の情報を請求書に書くだけでよく、日本円同士の振り込みとほとんど変わりませんでした。SWIFT というのは銀行機関識別コードらしく、銀行によって違うので UFJ 以外を利用する場合は適宜確認してください。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Payment Information:
</span><span class='line'>  Name of depositor: YOUR NAME
</span><span class='line'>  Name of bank: THE BANK OF TOKYO-MITSUBISHI UFJ, LTD. (XXXXX Branch)
</span><span class='line'>  Address: X-X-X XXXX XXXX Tokyo Japan
</span><span class='line'>  SWIFT: BOTKJPJT
</span><span class='line'>  IBAN: XXX-XXXXXXX (SAVING ACCOUNT)</span></code></pre></td></tr></table></div></figure>


<p>ちなみに入金されると、銀行から &ldquo;外国送金・本支店間外貨送金計算書&rdquo; なる封書が送られてきて、換算レートと手数料を確認できるのですが、手数料が 1500 円も取られていました&hellip;。(高い！)</p>

<h2>まとめ</h2>

<p>誰かに買ってもらうことを期待して写真撮ってるわけじゃないですが、いざ外国の雑誌で使って貰えるようなオファーが来るのはなかなか嬉しい体験なもので、最近、一眼レフ持ち歩くのダルくなりはじめてましたが、もうちょっとがんばってみようかなって気になってます (笑)</p>

<p>参考までに、お買い上げいただいた写真も貼っておきます。御柱みたいなちょっとマイナーな写真だと同じような写真が少なくて買ってもらいやすそうですね :D</p>

<p><img src="https://farm5.staticflickr.com/4044/4591557180_8d3dbdd778_z.jpg" width="340" height="512" title="'Ki Otoshi by Takumi Sakamoto (takus) on fickr.com'" ></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/02/23/docker/">Immutable Infrastructure Hackathon :D で docker をさわってみた</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/02/23/docker/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/02/23/docker/"></a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-02-23T21:42:00-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>9:42 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Immutable Infrastructure Hackathon :D で <a href="https://www.docker.io/">Docker</a> を触ってみただけという、ゆるふわなメモです。@muddydixon さんや @yosuke_furukawa さんが <a href="http://blog.drone.io/">drone</a> を触ってたのに比べてだいぶ素人丸出しな感じですが、Docker 童貞からは脱却できたので、次は &ldquo;<a href="http://blog.tmtk.net/2013/09/28/docker-jenkins-serverspec-puppet.ja.html">Docker + Jenkins + serverspecでpuppetのmanifestをCIする</a>&rdquo; あたりに取り組んでみたいと思いました。</p>

<h2>公式チュートリアル</h2>

<p>まず、<a href="https://www.docker.io/gettingstarted/">公式サイトのチュートリアル</a>で一通り使い方を学びました。</p>

<h2>Docker on DigitalOcean</h2>

<p>DigitalOcean は 1GB メモリのサーバが 1 時間 $0.015 で使える格安の VPS サーバで、手元で VM 動かしたくなかったので使ってみました。Docker は &ldquo;<a href="http://blog.glidenote.com/blog/2013/12/20/vagrant-docker-digitalocean/">MacからVagrantコマンド一発でSSDなVPS(DigitalOcean)上にCentOS6.5+Docker環境を構築する</a>&rdquo; を参考に入れます。</p>

<p>最初は CentOS 6.4 に Docker をインストールして docker build していましたが、メモリ枯渇して OOMKiller 発動したり不安定だったので、公式サポートされてるという CentOS 6.5 にしました。ちなみに IPv6 が有効になってると <code>docker run -p</code> したときに IPv4 のアドレスを bind してくれなかったので無効にしてます。</p>

<h2>Ukigumo-Server on Docker</h2>

<p>Docker が動くようになったので、@kazeburo 先生の &ldquo;<a href="http://blog.nomadscafe.jp/2013/12/centos-65dockergrowthforecast.html">CentOS 6.5にDockerいれてGrowthForecastを動かしてみた</a>&rdquo; を参考に Ukigumo-Server の image を作ってみました。</p>

<h3>Dockerfile</h3>

<p>元の Dockerfile では <code>EXEC</code> してましたが、 <code>EXEC</code> 使うより <code>ENTRYPOINT</code> で引数渡せるようにした方が <code>docker run</code> するときに引数指定できて便利そうだったのでそうしてます。Dockerfile のコマンドについては、<a href="http://docs.docker.io/en/latest/reference/builder/">公式ドキュメント</a> が参考になりました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FROM centos
</span><span class='line'>MAINTAINER Takumi Sakamoto, takus
</span><span class='line'>RUN yum -y groupinstall "Development Tools"
</span><span class='line'>RUN git clone https://github.com/tagomoris/xbuild.git
</span><span class='line'>RUN xbuild/perl-install 5.18.1 /opt/perl-5.18
</span><span class='line'>RUN echo 'export PATH=/opt/perl-5.18/bin:$PATH' &gt; /etc/profile.d/xbuild-perl.sh
</span><span class='line'>RUN /opt/perl-5.18/bin/cpanm -n Ukigumo::Server
</span><span class='line'>EXPOSE 2828
</span><span class='line'>ENTRYPOINT ["/opt/perl-5.18/bin/ukigumo-server"]</span></code></pre></td></tr></table></div></figure>


<h3>image を build して docker repository に push</h3>

<p>image を作って push してみました。push した image は<a href="https://index.docker.io/u/takus/ukigumo-server/">コチラ</a>にあります。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker login
</span><span class='line'>Username: xxxx
</span><span class='line'>Password:
</span><span class='line'>Email: xxxx
</span><span class='line'>Login Succeeded
</span><span class='line'>
</span><span class='line'>$ docker build -t takus/ukigumo-server .
</span><span class='line'>Successfully built 14b737e414c6
</span><span class='line'>
</span><span class='line'>$ docker images
</span><span class='line'>REPOSITORY             TAG                 IMAGE ID            CREATED              VIRTUAL SIZE
</span><span class='line'>takus/ukigumo-server   latest              14b737e414c6        About a minute ago   1.33 GB
</span><span class='line'>
</span><span class='line'>$ docker run -p 2828:2828 takus/ukigumo-server
</span><span class='line'>d3b31b2f8603344636435d18138a74ff365cc5797f10fe900cc16d05b0451fe0
</span><span class='line'>
</span><span class='line'>$ docker push takus/ukigumo-server
</span><span class='line'>d4fc918d1e82: Image successfully pushed
</span><span class='line'>Pushing tag for rev [d4fc918d1e82] on {https://registry-1.docker.io/v1/repositories/takus/ukigumo-server/tags/latest}
</span></code></pre></td></tr></table></div></figure>


<h3>他の人が作った image をもってきてみる</h3>

<p>試しに @sonots さんの growthforecast の image をもってきて動かしてみました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker search growthforecast
</span><span class='line'>NAME                            DESCRIPTION   STARS     OFFICIAL   TRUSTED
</span><span class='line'>futoase/docker-growthforecast                 0                    [OK]
</span><span class='line'>sonots/growthforecast                         0
</span><span class='line'>
</span><span class='line'>$ docker pull sonots/growthforecast
</span><span class='line'>1c7f181e78b9: Download complete
</span><span class='line'>
</span><span class='line'>$ docker run -p 5125:5125 sonots/growthforecast
</span><span class='line'>d3b31b2f8603344636435d18138a74ff365cc5797f10fe900cc16d05b0451fe0</span></code></pre></td></tr></table></div></figure>


<p>こんな感じで雰囲気は分かったのでもう少し触ってみたいと思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/01/28/nagios-resource-graph/">Nagios のアラートに CloudForecast へのリンクをつける</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/01/28/nagios-resource-graph/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/01/28/nagios-resource-graph/"></a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-01-28T23:36:00-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>といっても、単に <code>Graph: http://cf.example.com/server?address=$HOSTADDRESS$\n</code> みたいな記述を <code>command.cfg</code> に追加してあげるだけの話です。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define command {
</span><span class='line'>  command_name  notify-service-by-email
</span><span class='line'>  command_line  /usr/bin/printf "%b" "***** Nagios *****\n\nNotification Type: $NOTIFICATIONTYPE$\n\nService: $SERVICEDESC$\nHost: $HOSTALIAS$\nAddress: $HOSTADDRESS$\nGraph: http://cf.example.com/server?address=$HOSTADDRESS$ \nState: $SERVICESTATE$\n\nDate/Time: $LONGDATETIME$\n\nAdditional Info:\n\n$SERVICEOUTPUT$\n" | @MAIL_PROG@ -s "** $NOTIFICATIONTYPE$ Service Alert: $HOSTALIAS$/$SERVICEDESC$ is $SERVICESTATE$ **" $CONTACTEMAIL$
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>アラートメールは下記のようになるので、メールからすぐにリソースグラフにアクセスできて捗るようになりました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>***** Nagios *****
</span><span class='line'>
</span><span class='line'>Notification Type: PROBLEM
</span><span class='line'>
</span><span class='line'>Service: MEMORY
</span><span class='line'>Host: host0001
</span><span class='line'>Address: 10.0.1.11
</span><span class='line'>Graph: http://cf.example.com/server?address=10.0.1.11
</span><span class='line'>State: CRITICAL
</span><span class='line'>
</span><span class='line'>Date/Time: Tue Jan 28 20:08:40 JST 2014
</span><span class='line'>
</span><span class='line'>Additional Info:
</span><span class='line'>
</span><span class='line'>Ram : 96%, Swap : 0% :  93, 10 : CRITICAL</span></code></pre></td></tr></table></div></figure>


<p>他にも <code>http://gf.example.com/list/Host/$HOSTALIAS$?t=sh</code> みたいにして、ホスト名ごとに出力している GrowthForecast へのリンクをつけるみたいにしても便利そうな気がします。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/01/18/fluent-plugin-ec2-metadata/">fluent-plugin-ec2-metadata という fluentd プラグインを書いてみた</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/01/18/fluent-plugin-ec2-metadata/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/01/18/fluent-plugin-ec2-metadata/"></a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-01-18T13:31:00-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>1:31 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/takus/fluent-plugin-ec2-metadata">takus/fluent-plugin-ec2-metadata</a></p>

<p>前々から fluentd のプラグインを書いてみようと思っていたので、ec2 の metadata をレコードに追加するようなプラグインを書いてみました。プラグインの書き方は @tagomoris 先生の <a href="http://d.hatena.ne.jp/tagomoris/20120221/1329815126">&ldquo;fluentdのためのプラグインをイチから書く手順(bundler版)&rdquo;</a> が大変参考になったので、プラグインを書いてみたい人は見るとよさそうです。あとは、@sonots 先生の <a href="https://github.com/sonots/fluent-plugin-record-reformer">fluent-plugin-record-reformer</a> をかなり参考にさせていただいたのと、Ruby 初心者なので<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774158798/takus-22/ref=nosim">&ldquo;パーフェクトRuby&rdquo;</a>にもお世話になりました。</p>

<h2>なにをするプラグインか？</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="err">###</span> <span class="nx">Input</span>
</span><span class='line'><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;hello ec2!&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="err">###</span> <span class="nx">Output</span>
</span><span class='line'><span class="nx">web</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;role_tag&quot;</span>      <span class="o">:</span> <span class="s2">&quot;web&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;instance_id&quot;</span>   <span class="o">:</span> <span class="s2">&quot;i-28b5ee77&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;instance_type&quot;</span> <span class="o">:</span> <span class="s2">&quot;m1.large&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;az&quot;</span>            <span class="o">:</span> <span class="s2">&quot;us-west-1b&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;vpc_id&quot;</span>        <span class="o">:</span> <span class="s2">&quot;vpc-25dab194&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;message&quot;</span>       <span class="o">:</span> <span class="s2">&quot;hello ec2!&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>たとえばこんな感じにレコードを出力してくれます。先週の月曜日に <a href="http://blog.livedoor.jp/sonots/archives/35635267.html">Immutable Infrastructure Hackathon at :D</a> というイベントをやっていたときに、EC2 で Immutable Infrastructure 前提ならホスト名ベースででなく EC2 のタグに入れた Role ベースで集計するのがいいのではないか思ったのがきっかけで、それっぽいプラグインがなかったので作ってみた感じです。</p>

<blockquote><p>サーバに名前をつけるという行為はもはや古い慣習であり、クラウドネイティブな思考を妨げる足かせになります。</p><p>クラウドでは、サーバはソフトウェアのように扱われます。いつでも必要に応じて立ち上げ、不要になれば簡単に削除することができます。そのような状況で、サーバ1台1台に手動でユニークな名前をつけていくことは、オートスケールをはじめとするクラウドの恩恵を失うことになります。ではどのようにサーバを管理するべきかというと、DNS で名前をつけるのではなく、 EC2 のタギング機能を使ってサーバの属性を記述し、識別するべきである、と述べられています。</p><footer><strong>@mirakui</strong> <cite><a href='http://blog.mirakui.com/entry/2013/11/21/reinvent-immutable-infrastructure'>AWS re:Invent と Immutable Infrastructure</a></cite></footer></blockquote>




<blockquote><p>また、ホストがどんどん新しくなるので、負荷観測の連続性をどのように確保するか、などメトリクス情報の保存や可視化に関する課題もあります。</p><footer><strong>@stanaka</strong> <cite><a href='http://blog.stanaka.org/entry/2013/12/01/092642'>2014年のウェブシステムアーキテクチャ</a></cite></footer></blockquote>


<p>@mirakui さんのブログや @stanaka さんのブログにも上記のような内容が書いてあり、AWS 上で fluentd を使っていて EC2 のタグ毎に集計したい場合は役に立つプラグインなのではないかと思っています。</p>

<h2>設定ファイル</h2>

<p>設定ファイルは下記のような感じで、<a href="http://y-ken.hatenablog.com/entry/fluentd-how-to-use-tag_parts-placeholder">タグの書き換えに便利な tag_parts</a> もサポートしております。EC2 のタグのプレースホルダー名は若干悩んだところですが、aws-sdk で返ってくるフィールド名に合わせて <code>tagset_xxx</code> にしました。</p>

<pre><code>&lt;match foo.**&gt;
  type ec2_metadata

  aws_key_id  YOUR_AWS_KEY_ID
  aws_sec_key YOUR_AWS_SECRET/KEY

  output_tag ${instance_id}.${tag_parts[0]}
  &lt;record&gt;
    tag           ${tagset_name}
    instance_id   ${instance_id}
    instance_type ${instance_type}
    az            ${availability_zone}
    vpc_id        ${vpc_id}
  &lt;/record&gt;
&lt;/match&gt;
</code></pre>

<h2>今後について</h2>

<p>テストコードが EC2 に依存していて TravisCI ではテストできないので、どうしようか考え中です。CircleCI だと<a href="http://d.hatena.ne.jp/naoya/20131215/1387090668">こんなカンジ</a>で EC2 にインスタンス立ち上げてよしなにテストしてくれるようなことができそうなので、その辺りを調べてみようかと思っていますが、これ使ってテストすればいいのではというアイデアがありましたら、教えていただけると大変助かります！</p>

<p>あとは必要最低限のプレースホルダーは用意しましたが、これも使いたいみたいなのがあればお知らせください。もちろんそのほかのバグ報告や PR もウェルカムです:D</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/01/05/survival-strategy/">サイドバックの生存戦略</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/01/05/survival-strategy/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/01/05/survival-strategy/"></a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-01-05T00:14:00-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:14 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>単純にサッカーが好きなこともあるが、サッカー選手が書いている本を昔からよく読んでいる方だと思う。サッカー選手とは置かれてる状況が全然違うものの、時には共感することや実践したいと思うようなことに巡り会うことがある。</p>

<p>で、正月に Amazon を徘徊してたら、内田篤人の「<a href="http://www.amazon.co.jp/exec/obidos/ASIN/B00E3OZRIO/takus-22/ref=nosim">僕は自分が見たことしか信じない</a>」が期間限定セールで 299 円になってたので読んでみたところ、引っかかったことがあったので書いてみる。</p>

<blockquote><p>(南アW杯で試合に出れなかったことをうけて、どうしたら常に試合に出られるのかを一番意識するようになったという文脈で)そこで、目指すのはチーム全体に好影響を与えられる選手。内田がいれば、なぜか攻守がうまく回り、なぜかチームが勝つ。見る人がそんな風に感じてくれら嬉しい。</p></blockquote>


<p>長谷部誠も「<a href="http://www.amazon.co.jp/exec/obidos/ASIN/B00977H3NO/takus-22/ref=nosim">心を整える</a>」で同じようなことを言っていた気もするが、ボランチやサイドバックは周りから見たら評価しにくい選手で、メッシやクリロナのように試合を決める選手に比べると貢献がみえにくい。</p>

<p>これは自分の仕事とかなり似ている気がしている。例えば、アプリ開発してる人はそのアプリが売れれば結果を出してることが明確で分かりやすいけど、それに比べるとシステム運用の仕事って評価しにくいのではないかと思うことがある。</p>

<p>そんな状況で、エンジニアとしてどうやって生き残っていくべきか、評価して貰えるようになるかって考えてたことがあって、そのとき行き着いたのは、結局、「なんとなくアイツに任せておくとイイカンジにしてくれる」とか「アイツとやると、なんかいいカンジにプロジェクトが回る気がする」みたいなことで、この本を読んでサイドバックの生存戦略と自分の生存戦略は似ていると感じた。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/12/31/2013-to-2014/">さよなら 2013 年</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2013/12/31/2013-to-2014/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2013/12/31/2013-to-2014/"></a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-12-31T16:05:00-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2013</span></span> <span class='time'>4:05 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>年の瀬ということで今年を振り返ってみます。</p>

<h2>仕事のこと</h2>

<p>一言でいうならすごく仕事の守備範囲が広がった一年だった印象です。サッカーで例えると今まで FW 1 本でやってきた選手が、MF もやるようになってプレーの幅が広がったような感じでしょうか(適当)。運用に関わる範囲が増えただけでなく、オペミスしたら甚大な被害が出そうな作業も「任せておけばイイカンジになりますか？」と上司に振られるようになったり、新しい仕組みの導入なども積極的にやらせてもらえる (勝手にやってるともいえるが&hellip;) ようになったり、色々とやらせてもらえるようになった結果としてエンジニアとしての幅が広がったのではないかと思います！</p>

<p>また、海外拠点の人とやり取りする機会が増えた結果、最近はメールや IRC も半分くらいは英語で書くような生活をするようになったり、日によっては 1 日中英語喋ってるようなときもあり、コミュニケーションという面でも出来ることの幅は広がっていった一年でした。</p>

<p>一方で、人に教えるようになるにつれて<a href="http://shibats.tumblr.com/post/62197134380">「自分でやった方が早い病」</a> みたいに思うことがあったり、人に教えるとかマネジメントするとか難しいなとか思いながら、その辺はモヤモヤしながら試行錯誤してた気がします。</p>

<h2>プライベートなこと</h2>

<h3>アメリカ初上陸 &amp; 海外カンファレンス初参戦</h3>

<p>5 月にロサンゼルスとニューヨーク、6 月にサンフランシスコと、はじめてアメリカに行きました。特に 6 月のサンフランシスコでは、<a href="http://velocityconf.com/">Velocity Conference</a> という Web operation や Web performance に関するカンファレンスに参加できたのはすごく印象深い思い出です。初めての海外カンファレンスなのに一人で参加したこともあり、最初はぼっち感がハンパなかったですが、初日に LT したことも助けになり、最終的には色んな人と喋れたので、とてもいい経験になりました。</p>

<p><a href="http://blog.takus.me/2013/06/21/velocity-conference-santa-clara-2013/">Velocity 2013 に参加 &amp; LT してきました！！</a></p>

<h3>若手 Web エンジニア交流会</h3>

<p>今年は@<a href="http://www.zusaar.com/event/521003">クックパッド</a>、@<a href="http://www.zusaar.com/event/733053">mixi</a>、@<a href="http://www.zusaar.com/event/1063003">Google</a> と 3 回も開催させていだだきました。いつもオフィスを貸していただいたり、準備を手伝ってくれてる皆様、本当にありがとうございます。募集ページに &ldquo;基本的に新卒 3 年目前後のウェブエンジニアを対象としています&rdquo; って書いてあり、そろそろ若手も名乗れなくなってくるので、今後の方向性については模索している段階です(笑</p>

<script async class="speakerdeck-embed" data-id="2eb68c500dac013190b426a0f1d35487" src="//speakerdeck.com/assets/embed.js"></script>


<p>↑第 6 回のときに LT したスライド</p>

<h3>(個人的) 電子書籍元年</h3>

<p>Kindle が上陸したのは 去年な気がしますが、今年になってからすごく読む機会が増えました。都会の家は狭くてたくさん本が置けるような本棚も置けないので物理的な本を買うのはすごく億劫なのと、そもそもいつも Mac やガジェット持ち歩いているために本を入れるスペースがないこともあって、読みたい本があってもスルーする機会が多かったですが、Kindle ストアや O&#8217;Reilly のオンラインストアで気軽に本を買って読めるようになったのは自分にとっては非常に大きかったです。例えば &ldquo;<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4873116384/takus-22/ref=nosim">実践ハイパフォーマンスMySQL</a>&rdquo; という MySQL の名著は 864 ページもあって、人を殺せるくらい分厚い本ですが、電子書籍なら物理的なスペースゼロなので、気軽に買って読むことができました。紙に比べて不便な部分もないわけではないですが、自分にとってはそれ以上のメリットがあるので、来年も電子書籍にはお世話になっていくことでしょう。</p>

<p>価格面でも、5000 円くらいする &ldquo;<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4873116384/takus-22/ref=nosim">実践ハイパフォーマンスMySQL</a>&rdquo; が、オライリーのセール時に買うとわずか $19.99 で買えたり、お財布にも優しいのが嬉しいところです。<a href="http://zentoo.hatenablog.com/entry/2013/11/10/010121">情報系学生向けの読書術・2013年度版</a> にも書いてある通り、特に学生さんにはオススメです。</p>

<h3>よいお年を</h3>

<p>今年はこんなイケテルもの作ったぜヒャッハー！みたいな内容にならないのが大変残念な感じなので、来年こそはその辺りをがんばっていこうと思っております。ということで、今年お世話になった方々、色々とありがとうございました。来年もよろしくお願いいたします。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/12/21/innodb-stats-on-metadata/">innodb_stats_on_metadata に要注意</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2013/12/21/innodb-stats-on-metadata/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2013/12/21/innodb-stats-on-metadata/"></a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-12-21T18:25:00-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2013</span></span> <span class='time'>6:25 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>一日に数回 MySQL が詰まるような現象があったので原因を調べたところ、そのサーバだけ <code>innodb_stats_on_metadata=1</code> になっていたのが原因だったという話デス。</p>

<p><code>innodb_stats_on_metadata</code> は、テーブルのメタデータにアクセスしたときに InnoDB の統計情報を更新するかどうかのフラグで、今回問題が起こっていたサーバのようにデータ量が多いサーバなどでは無効にしておく必要があります。例えば、<a href="http://dev.mysql.com/doc/refman/5.1-olh/ja/innodb-parameters.html#sysvar_innodb_stats_on_metadata">公式ドキュメント</a> の <code>innodb_stats_on_metadata</code> の部分にはこのように書いてあります。</p>

<blockquote><p>この変数が有効 (この変数が作成される前からのデフォルト) な場合、<code>SHOW TABLE STATUS</code> や <code>SHOW INDEX</code> などのメタデータステートメントの実行時や、<code>INFORMATION_SCHEMA</code> テーブル <code>TABLES</code> または <code>STATISTICS</code> へのアクセス時に、InnoDB は統計情報を更新します。(これらの更新は、<code>ANALYZE TABLE</code> で行われるものに似ている。) 無効な場合、InnoDB はそれらの処理中に統計情報を更新しません。この変数を無効にすると、テーブルやインデックスを多数含むスキーマへのアクセス速度が改善される可能性があります。またその場合、InnoDB テーブルが関係するクエリーの実行計画の安定性も高まる可能性があります。</p></blockquote>

<p>他にも MySQL Performance Blog の <a href="http://www.mysqlperformanceblog.com/2011/12/23/solving-information_schema-slowness/">Solving INFORMATION_SCHEMA slowness</a> という記事や、High Performance MySQL 3rd Edition の 5 章にもこのオプションに関する言及がありました。</p>

<p>性能に影響与えるようなオプションであればデフォルトで無効にしておいてくれればいいのにと思っていたら、<a href="https://blogs.oracle.com/supportingmysql/entry/server_defaults_changes_in_mysql">MySQL 5.6 からデフォルトで無効</a>になるようです。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page3">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/index.html">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <div style="margin-top:10px">
    <img src="http://farm8.staticflickr.com/7293/11929418323_e084604fe5_q.jpg" alt="me"><br />
    Takumi Sakamoto<br />
    Software Engineer@SmartNews, Inc.<br />
  </div>
  <div style="margin-top:10px">
    <a href="http://twitter.com/takus" class="twitter-follow-button" data-show-count="true">Follow @takus</a>
  </div>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/11/12/reinvent-2014-day1/">AWS re:Invent 2014 day1</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/11/12/reinvent-2014-day1/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/11/12/reinvent-2014-day1/"></a>
      </li>
    
      <li class="post">
        <a href="/2014/08/31/yapc-asia-2014/">YAPC::Asia 2014 にいってきた #yapcasia</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/08/31/yapc-asia-2014/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/08/31/yapc-asia-2014/"></a>
      </li>
    
      <li class="post">
        <a href="/2014/08/01/join-smartnews/">スマートニュースにジョインしました</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/08/01/join-smartnews/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/08/01/join-smartnews/"></a>
      </li>
    
      <li class="post">
        <a href="/2014/07/31/got-married-and-leave-dena/">結婚しました & 退職します</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/07/31/got-married-and-leave-dena/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/07/31/got-married-and-leave-dena/"></a>
      </li>
    
      <li class="post">
        <a href="/2014/05/16/travel-to-barcelona/">Barcelona にいってきた</a><a href="http://b.hatena.ne.jp/entry/http://blog.takus.me/2014/05/16/travel-to-barcelona/"><img src="http://b.hatena.ne.jp/entry/image/large/http://blog.takus.me/2014/05/16/travel-to-barcelona/"></a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/takus">@takus</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'takus',
            count: 5,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Takumi Sakamoto -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'takus';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
